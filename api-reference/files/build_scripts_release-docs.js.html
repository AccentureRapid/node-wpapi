<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>build/scripts/release-docs.js - wpapi</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                    <h1 class="project-name">wpapi</h1> <span class="project-version">0.9.1</span>
                    <p class="description">A client for interacting with the WordPress REST API</p>
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
                <div id="api-tabview" class="tabview">
                    <ul class="tabs">
                        <li><a href="#api-classes">Classes</a></li>
                        <li><a href="#api-modules">Modules</a></li>
                    </ul>
            
                    <div id="api-tabview-filter">
                        <input type="search" id="api-filter" placeholder="Type to filter APIs">
                    </div>
            
                    <div id="api-tabview-panel">
                        <ul id="api-classes" class="apis classes">
                            <li><a class="type" href="../classes/wp.html">wp</a></li>
                            <li><a class="type" href="../classes/WP.html">WP</a></li>
                            <li><a class="type" href="../classes/WPRequest.html">WPRequest</a></li>
                        </ul>
            
                        <ul id="api-modules" class="apis modules">
                            <li><a class="module" href="../modules/autodiscovery.html">autodiscovery</a></li>
                            <li><a class="module" href="../modules/filters.html">filters</a></li>
                            <li><a class="module" href="../modules/parseRouteString.html">parseRouteString</a></li>
                            <li><a class="module" href="../modules/WP.html">WP</a></li>
                            <li><a class="module" href="../modules/WPRequest.html">WPRequest</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: build/scripts/release-docs.js</h1>
                
                <div class="file">
                    <pre class="code prettyprint linenums">
                &#x27;use strict&#x27;;
                
                const fs = require( &#x27;fs&#x27; );
                const path = require( &#x27;path&#x27; );
                const prompt = require( &#x27;prompt&#x27; );
                const spawn = require( &#x27;child_process&#x27; ).spawn;
                
                // Get package info
                const pkg = require( &#x27;../../package.json&#x27; );
                
                // This is the commit message that will be used by the script
                const commitMessage = &#x60;Release latest documentation for node-wpapi v${pkg.version}&#x60;;
                
                // Run all commands in base project directory
                const projectRoot = path.join( __dirname, &#x27;../..&#x27; );
                
                // This regex is used to exclude hidden files, the Gemfile.lock, and combyne
                // templates (which are used to generate Jekyll files, and not needed on the
                // deployed site)
                const OMIT_FILE_RE = /^\.|\.lock|\.combyne$/;
                
                // This regex is used to find directories to explicitly rm -rf when copying
                // files from the temporary directory into the repo proper: we make the
                // incorrect but still helpful assumption that no file extension means that
                // something is a directory. This means Gemfile and other no-ext files are
                // unnecessarily deleted, but it makes things work with minimal complexity.
                const PROBABLY_A_DIRECTORY_RE = /^[^\.]+$/;
                
                // RE to match &quot;y&quot;, yes&quot;, &quot;yeah&quot;, &quot;yes please&quot;, and other affirmative responses
                const AFFIRMATIVE_RE = /^y(:?e[asp]?h?)?(:? [^\n]+)?\s*$/i;
                
                /**
                 * Helper method to request yes/no confirmation from the user, with some
                 *
                 * @private
                 * @returns {Promise} A promise that will resolve with a boolean true/false
                 * indicating whether assent was given
                 */
                const promptYN = () =&gt; new Promise( ( resolve, reject ) =&gt; {
                	prompt.message = &#x27;&#x27;;
                	prompt.start();
                	prompt.get([ &#x27;y/n&#x27; ], ( err, result ) =&gt; {
                		if ( err ) {
                			return reject( err );
                		}
                		resolve( AFFIRMATIVE_RE.test( result[ &#x27;y/n&#x27; ] ) );
                	});
                });
                
                /**
                 * Get the list of files in a directory, either as a list of file and subdir
                 * names or a list of absolute file system paths
                 *
                 * @private
                 * @param {string} inputDir The file system path to the directory to read
                 * @returns {Promise} A promise to the string array of file names
                 */
                const ls = ( inputDir, absolute ) =&gt; {
                	return new Promise( ( resolve, reject ) =&gt; {
                		fs.readdir( inputDir, ( err, list ) =&gt; {
                			if ( err ) {
                				return reject( err );
                			}
                
                			resolve( list );
                		});
                	});
                };
                
                /**
                 * Spawn a shell command, pipe its output to the parent process&#x27;s stdio, and
                 * return a promise that will resolve or reject when the subprocess completes
                 *
                 * @private
                 * @param {string}   commandStr  A string containing a shell command to run
                 * @param {string[]} [otherArgs] Array of additional string arguments, so that
                 * quoted arguments with spaces like github commit messages will not be broken
                 * @returns {Promise} A promise that will resolve if the command executes
                 * successfully or reject if it errors
                 */
                const runCommand = ( commandStr, otherArgs ) =&gt; {
                	return new Promise( ( resolve, reject ) =&gt; {
                		const commandArgs = commandStr.split( &#x27; &#x27; );
                		if ( Array.isArray( otherArgs ) ) {
                			otherArgs.forEach( arg =&gt; commandArgs.push( arg ) );
                		}
                		const command = commandArgs.shift();
                
                		const spawnedCommand = spawn( command, commandArgs, {
                			cwd: projectRoot,
                			stdio: &#x27;inherit&#x27;
                		});
                
                		spawnedCommand.on( &#x27;error&#x27;, err =&gt; {
                			reject( err );
                		});
                
                		spawnedCommand.on( &#x27;close&#x27;, code =&gt; {
                			return code ? reject( code ) : resolve();
                		});
                	});
                };
                
                /**
                 * Helper function that takes in an array of functions that return promises,
                 * then executes those functions sequentially to execute each action
                 *
                 * @param {function[]} arrOfFnsReturningPromises An array of functions
                 * @returns {Promise} A promise that will resolve once all the promises
                 * returned by that function successfully complete
                 */
                const runInSequence = arrOfFnsReturningPromises =&gt; {
                	return arrOfFnsReturningPromises.reduce(
                		( lastStep, startNextStep ) =&gt; lastStep.then( startNextStep ),
                		Promise.resolve()
                	);
                };
                
                // Start fresh
                runCommand( &#x27;rm -rf docs-tmp&#x27; )
                	// Make sure that we know what we are doing
                	.then( () =&gt; new Promise( ( resolve, reject ) =&gt; {
                		console.log( &#x27;\nBefore we begin,&#x27; );
                		console.log( &#x27;1. Are you on the &quot;master&quot; branch?&#x27; );
                		console.log( &#x27;2. Does &quot;git status&quot; show that HEAD is clean?&#x27; );
                		console.log( &#x27;3. Is the code in &quot;master&quot; current with a released version?&#x27; );
                		console.log( &#x27;\nWhatever is in this branch will be released in the public .zip download.&#x27; );
                		console.log( &#x27;By proceeding, you affirm that this is not going to ruin anybody\&#x27;s day.&#x27; );
                		console.log( &#x27;\nContinue?&#x27; );
                
                		return promptYN().then( result =&gt; {
                			if ( result ) {
                				console.log( &#x27;\nGreat, let\&#x27;s get this show on the road...&#x27; );
                				resolve();
                			} else {
                				console.log( &#x27;\nDiscretion is the better part of valor\n&#x27; );
                				// Throw a raw string to make the logging easier
                				reject( &#x27;(User aborted deployment process)&#x27; );
                			}
                		});
                	}) )
                	// Ensure the built JS library is up to date
                	// .then( () =&gt; runCommand( &#x27;npm run build&#x27; ) )
                	// Build the docs site content (web bundle .zip, generated pages, etc)
                	.then( () =&gt; runCommand( &#x27;npm run docs&#x27; ) )
                	// Copy the docs folder to a temp location to move its contents across branches
                	.then( () =&gt; runCommand( &#x27;cp -r documentation docs-tmp&#x27; ) )
                	.then( () =&gt; console.log( &#x27;\nTemporary directory created successfully. Switching branches...\n&#x27; ) )
                	// Switch to the docs site branch
                	.then( () =&gt; runCommand( &#x27;git checkout gh-pages&#x27; ) )
                	.then( () =&gt; console.log( &#x27;\nCopying files from temp directory...\n&#x27; ) )
                	// Get a list of generated files in the temp directory
                	.then( () =&gt; ls( path.join( projectRoot, &#x27;docs-tmp&#x27; ) ) )
                	// Filter out unneeded files from the list
                	.then( fileList =&gt; fileList.filter( result =&gt; ! OMIT_FILE_RE.test( result ) ) )
                	// Copy things from the temp directory down into the directory root
                	.then( fileList =&gt; {
                		// Create an array of functions that each remove a directory in the root of
                		// this project which could block the success of the &#x60;mv&#x60; command below
                		const removeDirectories = fileList
                			.filter( file =&gt; PROBABLY_A_DIRECTORY_RE.test( file ) )
                			.map( dir =&gt; {
                				// Ignore errors b/c they will usually be nothing more than a warning
                				// that a file we tried to delete didn&#x27;t exist to begin with
                				return () =&gt; runCommand( &#x60;rm -rf ${dir}&#x60; ).catch( err =&gt; console.log( err ) );
                			});
                
                		return runInSequence( removeDirectories ).then( () =&gt; fileList );
                	})
                	// Copy files over
                	.then( fileList =&gt; {
                		const copyFiles = fileList.map( file =&gt; {
                			return () =&gt; runCommand( &#x60;mv docs-tmp/${file} ./${file}&#x60; );
                		});
                		return runInSequence( copyFiles ).then( () =&gt; fileList );
                	})
                	.then( fileList =&gt; console.log( &#x60;${fileList.length} files moved successfully&#x60; ) )
                	// Remove the temp directory
                	.then( () =&gt; runCommand( &#x27;rm -rf docs-tmp&#x27; ) )
                	// Give the option of not re-deploying wpapi.zip: if the package&#x27;s contents
                	// have not changed but a new .zip is generated with the same contents, Git
                	// will still regard it as an updated file and too many of those could bloat
                	// the repo. Easier to exclude it for docs-only updates.
                	.then( () =&gt; new Promise( ( resolve, reject ) =&gt; {
                		console.log( &#x27;\nHas the wpapi.zip bundle changed since last deploy? (If unsure, answer &quot;Yes&quot;)&#x27; );
                
                		return promptYN().then( result =&gt; {
                			if ( result ) {
                				console.log( &#x27;Including updated wpapi.zip in build...&#x27; );
                				resolve();
                			} else {
                				console.log( &#x27;Removing unneeded wpapi.zip update from the commit&#x27; );
                				resolve( runCommand( &#x27;git checkout gh-pages wpapi.zip&#x27; ) );
                			}
                		});
                	}) )
                	// Stage files for commit
                	.then( () =&gt; runCommand( &#x27;git add .&#x27; ) )
                	// Require user confirmation before proceeding with the commit &amp; push
                	.then( () =&gt; new Promise( ( resolve, reject ) =&gt; {
                		console.log( &#x27;\nDocumentation staged for commit. Proceed with commit &amp; push?&#x27; );
                
                		return promptYN().then( result =&gt; {
                			if ( result ) {
                				console.log( &#x27;\nConfirmed, committing &amp; pushing docs branch...&#x27; );
                				resolve();
                			} else {
                				console.log( &#x27;\nCommit &amp; push canceled, exiting.\n&#x27; );
                				// Throw a raw string to make the logging easier
                				reject( &#x27;(User aborted deployment process)&#x27; );
                			}
                		});
                	}) )
                	// Commit files
                	.then( () =&gt; runCommand( &#x27;git commit -m&#x27;, [ &#x60;&quot;${commitMessage}&quot;&#x60; ] ) )
                	// Push docs branch
                	.then( () =&gt; runCommand( &#x27;git push origin gh-pages&#x27; ) )
                	// Switch back to master
                	.then( () =&gt; runCommand( &#x27;git checkout master&#x27; ) )
                	// Run the clean command again to remove any ignored docs files left over
                	// after switching back to master
                	.then( () =&gt; runCommand( &#x27;grunt clean&#x27; ) )
                	// Log success!
                	.then( () =&gt; console.log( &#x27;\nDocs site updated!&#x27; ) )
                	.catch( err =&gt; console.error( err ) );
                
                    </pre>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
