<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/shared/collection-request.js - wordpress-rest-api</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                
                
                    <h1 class="project-name">wordpress-rest-api</h1> <span class="project-version">0.3.1</span>
                
                
                    <p class="description">A client for interacting with the WordPress REST API</p>
                
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a class="type" href="../classes/CollectionRequest.html">CollectionRequest</a></li>
            
                <li><a class="type" href="../classes/MediaRequest.html">MediaRequest</a></li>
            
                <li><a class="type" href="../classes/PagesRequest.html">PagesRequest</a></li>
            
                <li><a class="type" href="../classes/PostsRequest.html">PostsRequest</a></li>
            
                <li><a class="type" href="../classes/TaxonomiesRequest.html">TaxonomiesRequest</a></li>
            
                <li><a class="type" href="../classes/TypesRequest.html">TypesRequest</a></li>
            
                <li><a class="type" href="../classes/UsersRequest.html">UsersRequest</a></li>
            
                <li><a class="type" href="../classes/WP.html">WP</a></li>
            
                <li><a class="type" href="../classes/WPRequest.html">WPRequest</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a class="module" href="../modules/CollectionRequest.html">CollectionRequest</a></li>
            
                <li><a class="module" href="../modules/MediaRequest.html">MediaRequest</a></li>
            
                <li><a class="module" href="../modules/PagesRequest.html">PagesRequest</a></li>
            
                <li><a class="module" href="../modules/PostsRequest.html">PostsRequest</a></li>
            
                <li><a class="module" href="../modules/TaxonomiesRequest.html">TaxonomiesRequest</a></li>
            
                <li><a class="module" href="../modules/TypesRequest.html">TypesRequest</a></li>
            
                <li><a class="module" href="../modules/UsersRequest.html">UsersRequest</a></li>
            
                <li><a class="module" href="../modules/WP.html">WP</a></li>
            
                <li><a class="module" href="../modules/WPRequest.html">WPRequest</a></li>
            
            </ul>
        </div>
    </div>
</div>

        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: lib/shared/collection-request.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;
/*jshint -W106 */// Disable underscore_case warnings in this file b/c WP uses them
/**
 * @module WP
 * @submodule CollectionRequest
 * @beta
 */
var WPRequest = require( &#x27;./wp-request&#x27; );
var _ = require( &#x27;lodash&#x27; );
var extend = require( &#x27;node.extend&#x27; );
var inherit = require( &#x27;util&#x27; ).inherits;
var qs = require(&#x27;qs&#x27;);

/**
 * CollectionRequest extends WPRequest with properties &amp; methods for filtering collections
 * via query parameters. It is the base constructor for most top-level WP instance methods.
 *
 * @class CollectionRequest
 * @constructor
 * @extends WPRequest
 * @extensionfor PagesRequest
 * @extensionfor PostsRequest
 * @extensionfor TaxonomiesRequest
 * @extensionfor TypesRequest
 * @extensionfor UsersRequest
 * @param {Object} options A hash of options for the CollectionRequest instance
 * @param {String} options.endpoint The endpoint URI for the invoking WP instance
 * @param {String} [options.username] A username for authenticating API requests
 * @param {String} [options.password] A password for authenticating API requests
 */
function CollectionRequest( options ) {
	/**
	 * Configuration options for the request such as the endpoint for the invoking WP instance
	 * @property _options
	 * @type Object
	 * @private
	 * @default {}
	 */
	this._options = options || {};

	/**
	 * A hash of filter values to parse into the final request URI
	 * @property _filters
	 * @type Object
	 * @private
	 * @default {}
	 */
	this._filters = {};

	/**
	 * A hash of taxonomy terms to parse into the final request URI
	 * @property _taxonomyFilters
	 * @type Object
	 * @private
	 * @default {}
	 */
	this._taxonomyFilters = {};

	/**
	 * A hash of non-filter query parameters
	 * This is used to store the query values for Type, Page &amp; Context
	 *
	 * @property _params
	 * @type Object
	 * @private
	 * @default {}
	 */
	this._params = {};

	/**
	 * A hash of values to assemble into the API request path
	 *
	 * @property _path
	 * @type Object
	 * @private
	 * @default {}
	 */
	this._path = {};

	/**
	 * The URL template that will be used to assemble endpoint paths
	 *
	 * @property _template
	 * @type String
	 * @private
	 * @default &#x27;&#x27;
	 */
	this._template = &#x27;&#x27;;

	/**
	 * An array of supported methods; to be overridden by descendent constructors
	 * @property _supportedMethods
	 * @type Array
	 * @private
	 * @default [ &#x27;head&#x27;, &#x27;get&#x27;, &#x27;put&#x27;, &#x27;post&#x27;, &#x27;delete&#x27; ]
	 */
	this._supportedMethods = [ &#x27;head&#x27;, &#x27;get&#x27;, &#x27;put&#x27;, &#x27;post&#x27;, &#x27;delete&#x27; ];
}

inherit( CollectionRequest, WPRequest );

// Private helper methods
// ======================

/**
 * Process arrays of taxonomy terms into query parameters.
 * All terms listed in the arrays will be required (AND behavior).
 *
 * @example
 *     prepareTaxonomies({
 *         tag: [ &#x27;tag1 &#x27;, &#x27;tag2&#x27; ], // by term slug
 *         cat: [ 7 ] // by term ID
 *     }) === {
 *         tag: &#x27;tag1+tag2&#x27;,
 *         cat: &#x27;7&#x27;
 *     }
 *
 * @param {Object} taxonomyFilters An object of taxonomy term arrays, keyed by taxonomy name
 * @return {Object} An object of prepareFilters-ready query arg and query param value pairs
 */
function prepareTaxonomies( taxonomyFilters ) {
	if ( ! taxonomyFilters ) {
		return [];
	}

	return _.reduce( taxonomyFilters, function( result, terms, key ) {
		// Trim whitespace and concatenate multiple terms with +
		result[ key ] = terms.map(function( term ) {
			// Coerce term into a string so that trim() won&#x27;t fail
			term = term + &#x27;&#x27;;
			return term.trim().toLowerCase();
		}).join( &#x27;+&#x27; );
		return result;
	}, {});
}

/**
 * Utility function for sorting arrays of numbers or strings.
 *
 * @param {String|Number} a The first comparator operand
 * @param {String|Number} a The second comparator operand
 * @return -1 if the values are backwards, 1 if they&#x27;re ordered, and 0 if they&#x27;re the same
 */
function alphaNumericSort( a, b ) {
	if ( a &gt; b ) {
		return 1;
	}
	if ( a &lt; b ) {
		return -1;
	}
	return 0;
}

// Prototype Methods
// =================

/**
 * Process the endpoint query&#x27;s filter objects into a valid query string.
 * Nested objects and Array properties are rendered with indexed array syntax.
 *
 * @example
 *     _renderQuery({ p1: &#x27;val1&#x27;, p2: &#x27;val2&#x27; });  // ?p1=val1&amp;p2=val2
 *     _renderQuery({ obj: { prop: &#x27;val&#x27; } });    // ?obj[prop]=val
 *     _renderQuery({ arr: [ &#x27;val1&#x27;, &#x27;val2&#x27; ] }); // ?arr[0]=val1&amp;arr[1]=val2
 *
 * @private
 *
 * @method _renderQuery
 * @return {String} A query string representing the specified filter parameters
 */
CollectionRequest.prototype._renderQuery = function() {
	// Build the full query parameters object
	var queryParams = extend( {}, this._params );

	// Prepare the taxonomies and merge with other filter values
	var taxonomies = prepareTaxonomies( this._taxonomyFilters );
	queryParams.filter = extend( {}, this._filters, taxonomies );

	// Parse query parameters object into a query string, sorting the object
	// properties by alphabetical order (consistent property ordering can make
	// for easier caching of request URIs)
	var queryString = qs.stringify( queryParams )
		.split( &#x27;&amp;&#x27; )
		.sort()
		.join( &#x27;&amp;&#x27; );

	// Prepend a &quot;?&quot; if a query is present, and return
	return ( queryString === &#x27;&#x27; ) ? &#x27;&#x27; : &#x27;?&#x27; + queryString;
};

/**
 * Set a parameter to render into the final query URI.
 *
 * @method param
 * @chainable
 * @param {String|Object} props The name of the parameter to set, or an object containing
 *                              parameter keys and their corresponding values
 * @param {String|Number|Array} [value] The value of the parameter being set
 * @param {Boolean} [merge] Whether to merge the value (true) or replace it (false, default)
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.param = function( props, value, merge ) {
	merge = merge || false;

	// We can use the same iterator function below to handle explicit key-value pairs if we
	// convert them into to an object we can iterate over:
	if ( _.isString( props ) &amp;&amp; value ) {
		props = _.object([[ props, value ]]);
	}

	// Iterate through the properties
	_.each( props, function( value, key ) {
		var currentVal = this._params[ key ];

		// Simple case: setting for the first time, or not merging
		if ( ! currentVal || ! merge ) {

			// Arrays should be de-duped and sorted
			if ( _.isArray( value ) ) {
				value = _.unique( value ).sort( alphaNumericSort );
			}

			// Set the value
			this._params[ key ] = value;

			// Continue
			return;
		}

		// value and currentVal must both be arrays in order to merge
		if ( ! _.isArray( currentVal ) ) {
			currentVal = [ currentVal ];
		}

		if ( ! _.isArray( value ) ) {
			value = [ value ];
		}

		// Concat the new values onto the old (and sort)
		this._params[ key ] = _.union( currentVal, value ).sort( alphaNumericSort );
	}.bind( this ));

	return this;
};

/**
 * Set the pagination of a request. Use in conjunction with &#x60;filter( posts_per_page )&#x60; for
 * explicit pagination handling. (The number of pages in a response can be retrieved from
 * the response&#x27;s &#x60;_paging.totalPages&#x60; property.)
 *
 * @method page
 * @chainable
 * @param {Number} pageNumber The page number of results to retrieve
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.page = function( pageNumber ) {
	return this.param( &#x27;page&#x27;, pageNumber );
};

/**
 * Set the context of the request. Used primarily to expose private values on a request
 * object, by setting the context to &quot;edit&quot;.
 *
 * @method context
 * @chainable
 * @param {String} context The context to set on the request
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.context = function( context ) {
	if ( context === &#x27;edit&#x27; ) {
		// Force basic authentication for edit context
		this.auth();
	}
	return this.param( &#x27;context&#x27;, context );
};

/**
 * Convenience wrapper for &#x60;.context( &#x27;edit&#x27; )&#x60;
 *
 * @method edit
 * @chainable
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.edit = function() {
	return this.context( &#x27;edit&#x27; );
};

/**
 * Specify key-value pairs by which to filter the API results (commonly used
 * to retrieve only posts meeting certain criteria, such as posts within a
 * particular category or by a particular author).
 *
 * @example
 *     // Set a single property:
 *     wp.filter( &#x27;post_type&#x27;, &#x27;cpt_event&#x27; )...
 *
 *     // Set multiple properties at once:
 *     wp.filter({
 *         post_status: &#x27;publish&#x27;,
 *         category_name: &#x27;news&#x27;
 *     })...
 *
 *     // Chain calls to .filter():
 *     wp.filter( &#x27;post_status&#x27;, &#x27;publish&#x27; ).filter( &#x27;category_name&#x27;, &#x27;news&#x27; )...
 *
 * @method filter
 * @chainable
 * @param {String|Object} props A filter property name string, or object of name/value pairs
 * @param {String|Number|Array} [value] The value(s) corresponding to the provided filter property
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.filter = function( props, value ) {
	// convert the property name string &#x60;props&#x60; and value &#x60;value&#x60; into an object
	if ( _.isString( props ) &amp;&amp; value ) {
		props = _.object([[ props, value ]]);
	}

	this._filters = extend( this._filters, props );

	return this;
};

/**
 * Restrict the query results to posts matching one or more taxonomy terms.
 *
 * @method taxonomy
 * @chainable
 * @param {String} taxonomy The name of the taxonomy to filter by
 * @param {String|Number|Array} term A string or integer, or array thereof, representing terms
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.taxonomy = function( taxonomy, term ) {
	var termIsArray = _.isArray( term );
	var termIsNumber = termIsArray ? _.isNumber( term[ 0 ] ) : _.isNumber( term );
	var termIsString = termIsArray ? _.isString( term[ 0 ] ) : _.isString( term );
	var taxonomyTerms;

	if ( ! termIsString &amp;&amp; ! termIsNumber ) {
		throw new Error( &#x27;term must be a number, string, or array of numbers or strings&#x27; );
	}

	if ( taxonomy === &#x27;category&#x27; ) {
		if ( termIsString ) {
			// Query param for filtering by category slug is category_name
			taxonomy = &#x27;category_name&#x27;;
		} else if ( termIsNumber ) {
			// Query param for filtering by category slug is category_name
			taxonomy = &#x27;cat&#x27;;
		}
	} else if ( taxonomy === &#x27;post_tag&#x27; ) {
		// tag is used in place of post_tag in the public query variables
		taxonomy = &#x27;tag&#x27;;
	}

	// Ensure there&#x27;s an array of terms available for this taxonomy
	taxonomyTerms = this._taxonomyFilters[ taxonomy ] || [];

	// Insert the provided terms into the specified taxonomy&#x27;s terms array
	if ( termIsArray ) {
		taxonomyTerms = taxonomyTerms.concat( term );
	} else {
		taxonomyTerms.push( term );
	}

	// Sort array
	taxonomyTerms.sort( alphaNumericSort );

	// De-dupe
	this._taxonomyFilters[ taxonomy ] = _.unique( taxonomyTerms, true );

	return this;
};

/**
 * Convenience wrapper for &#x60;.taxonomy( &#x27;category&#x27;, ... )&#x60;.
 *
 * @method category
 * @chainable
 * @param {String|Number|Array} category A string or integer, or array thereof, representing terms
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.category = function( category ) {
	return this.taxonomy( &#x27;category&#x27;, category );
};

/**
 * Convenience wrapper for &#x60;.taxonomy( &#x27;tag&#x27;, ... )&#x60;.
 *
 * @method tag
 * @chainable
 * @param {String|Number|Array} tag A tag term string or array of tag term strings
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.tag = function( tag ) {
	return this.taxonomy( &#x27;tag&#x27;, tag );
};

/**
 * Filter results to those matching the specified search terms.
 *
 * @method search
 * @param {String} searchString A string to search for within post content
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.search = function( searchString ) {
	return this.filter( &#x27;s&#x27;,  searchString );
};

/**
 * Query for posts by a specific author.
 * This method will replace any previous &#x27;author&#x27; query parameters that had been set.
 *
 * @method author
 * @chainable
 * @param {String|Number} author The nicename or ID for a particular author
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.author = function( author ) {
	if ( _.isString( author ) ) {
		delete this._filters.author;
		return this.filter( &#x27;author_name&#x27;, author );
	}
	if ( _.isNumber( author ) ) {
		delete this._filters.author_name;
		return this.filter( &#x27;author&#x27;, author );
	}
	throw new Error( &#x27;author must be either a nicename string or numeric ID&#x27; );
};

/**
 * Query a collection of posts for a post with a specific slug.
 *
 * @method name
 * @chainable
 * @param {String} slug A post name (slug), e.g. &quot;hello-world&quot;
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.name = function( slug ) {
	return this.filter( &#x27;name&#x27;, slug );
};

/**
 * Alias for &#x60;.name()&#x60;.
 *
 * @method slug
 * @alias name
 * @chainable
 * @param {String} slug A post slug, e.g. &quot;hello-world&quot;
 * @return {CollectionRequest} The CollectionRequest instance (for chaining)
 */
CollectionRequest.prototype.slug = CollectionRequest.prototype.name;

module.exports = CollectionRequest;

    </pre>
</div>

            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
